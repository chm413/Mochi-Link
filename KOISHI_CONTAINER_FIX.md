# Koishi 容器 Yarn 锁文件修复指南
# Koishi Container Yarn Lockfile Fix Guide

## 问题描述

你的 Koishi 容器遇到了以下错误并无法启动：

```
Internal Error: @koishijs/boilerplate@workspace:.: This package doesn't seem to be present in your lockfile; run "yarn install" to update the lockfile
```

### 根本原因

- 容器使用 **Yarn v4 (Berry)** 和 workspace 配置
- 但存在一个旧的 **Yarn v1 格式的 lockfile**
- Yarn v4 无法读取 v1 的 lockfile 格式
- 容器陷入无限错误循环，无法启动

---

## 解决方案

### 方法 1: 使用自动修复脚本（推荐）

我已经为你创建了一个自动修复脚本 `fix-koishi-container.bat`。

#### 使用步骤：

1. 确保 Docker 正在运行
2. 双击运行 `fix-koishi-container.bat`
3. 等待脚本完成
4. 容器将自动重启

#### 脚本做了什么：

1. ✅ 启动容器
2. ✅ 删除损坏的 `yarn.lock` 文件
3. ✅ 安装 Git（用于后续插件安装）
4. ✅ 重新生成 Yarn v4 兼容的 lockfile
5. ✅ 重启容器

---

### 方法 2: 手动修复

如果自动脚本不工作，可以手动执行：

#### 步骤 1: 启动并进入容器

```cmd
docker start koishi
docker exec -it koishi sh
```

如果容器立即停止，使用这个命令保持运行：

```cmd
docker run -it --entrypoint sh --name koishi-temp <你的镜像名>
```

#### 步骤 2: 删除损坏的 lockfile

```bash
cd /koishi
rm -f yarn.lock
```

#### 步骤 3: 安装 Git

```bash
apk add --no-cache git
```

#### 步骤 4: 重新生成 lockfile

```bash
yarn install
```

这会创建一个新的 Yarn v4 兼容的 lockfile。

#### 步骤 5: 退出并重启

```bash
exit
```

```cmd
docker restart koishi
```

---

### 方法 3: 从宿主机修复（如果使用了卷挂载）

如果你的 Koishi 数据在 Docker 卷中且可以从 Windows 访问：

#### 步骤 1: 找到卷位置

```cmd
docker volume inspect <卷名>
```

#### 步骤 2: 删除 lockfile

```cmd
del <卷路径>\yarn.lock
```

#### 步骤 3: 重启容器

```cmd
docker restart koishi
```

容器启动时会自动重新生成 lockfile。

---

## 安装 Mochi-Link 插件

容器修复并正常启动后，安装插件：

### 方法 A: 使用 Yarn（推荐）

```cmd
docker exec -it koishi sh
```

在容器内：

```bash
cd /koishi
yarn add git+https://github.com/chm413/Mochi-Link.git
```

### 方法 B: 手动编辑 package.json

1. 进入容器：

```cmd
docker exec -it koishi sh
```

2. 编辑 package.json：

```bash
vi /koishi/package.json
```

3. 在 `dependencies` 中添加：

```json
"koishi-plugin-mochi-link": "git+https://github.com/chm413/Mochi-Link.git"
```

4. 安装依赖：

```bash
yarn install
```

5. 重启容器：

```bash
exit
```

```cmd
docker restart koishi
```

---

## 验证修复

### 检查容器状态

```cmd
docker ps
```

应该看到 koishi 容器在运行。

### 检查日志

```cmd
docker logs koishi
```

不应该再看到 lockfile 错误。

### 检查插件安装

```cmd
docker exec -it koishi sh -c "cd /koishi && yarn list --pattern koishi-plugin-mochi-link"
```

应该显示插件已安装。

---

## 配置插件

1. 打开 Koishi Web UI（通常是 `http://localhost:5140`）
2. 进入"插件市场"或"已安装插件"
3. 找到 "mochi-link" 插件
4. 点击配置，填入：
   - WebSocket 端口
   - HTTP 端口
   - 数据库配置
   - 安全令牌
5. 启用插件

---

## 常见问题

### Q: 脚本运行后容器还是无法启动？

A: 检查 Docker 日志：

```cmd
docker logs koishi --tail 50
```

可能需要：
- 检查端口冲突
- 检查卷挂载权限
- 检查配置文件语法

### Q: 删除 yarn.lock 后还是报错？

A: 可能需要清理缓存：

```bash
docker exec -it koishi sh -c "cd /koishi && rm -rf .yarn/cache && yarn install"
```

### Q: Git 安装失败？

A: 如果 `apk add git` 失败，尝试：

```bash
apk update
apk add --no-cache git openssh-client
```

### Q: 插件安装后无法加载？

A: 检查：
1. 插件是否在 `package.json` 的 `dependencies` 中
2. 运行 `yarn install` 确保依赖已安装
3. 检查 Koishi 配置文件 `koishi.yml`
4. 查看容器日志中的错误信息

### Q: 如何完全重置容器？

A: 如果所有方法都失败，可以重新创建容器：

```cmd
REM 备份配置
docker cp koishi:/koishi/koishi.yml ./koishi.yml.backup

REM 停止并删除容器
docker stop koishi
docker rm koishi

REM 重新创建容器（使用你原来的命令）
docker run -d --name koishi ...

REM 恢复配置
docker cp ./koishi.yml.backup koishi:/koishi/koishi.yml
docker restart koishi
```

---

## 预防措施

### 避免未来出现此问题：

1. **使用 Docker Compose**：在 `docker-compose.yml` 中明确指定：

```yaml
version: '3'
services:
  koishi:
    image: koishijs/koishi:latest
    volumes:
      - ./data:/koishi
    ports:
      - "5140:5140"
    environment:
      - YARN_ENABLE_GLOBAL_CACHE=false
    command: sh -c "apk add --no-cache git && yarn install && yarn start"
```

2. **定期备份**：

```cmd
docker exec koishi tar -czf /tmp/koishi-backup.tar.gz /koishi
docker cp koishi:/tmp/koishi-backup.tar.gz ./koishi-backup.tar.gz
```

3. **使用版本锁定**：在 `package.json` 中明确指定 Yarn 版本：

```json
"packageManager": "yarn@4.1.0"
```

---

## 技术细节

### Yarn v1 vs Yarn v4 Lockfile 格式

**Yarn v1 (Classic)**:
```yaml
# THIS IS AN AUTOGENERATED FILE. DO NOT EDIT THIS FILE DIRECTLY.
# yarn lockfile v1

package@^1.0.0:
  version "1.0.0"
  resolved "https://..."
```

**Yarn v4 (Berry)**:
```yaml
# This file is generated by running "yarn install" inside your project.
# Manual changes might be lost - proceed with caution!

__metadata:
  version: 6
  cacheKey: 8

"package@npm:^1.0.0":
  version: 1.0.0
  resolution: "package@npm:1.0.0"
```

两者格式完全不兼容，必须删除旧的重新生成。

### Workspace 配置

你的 `package.json` 使用了 workspace 配置：

```json
{
  "name": "@koishijs/boilerplate",
  "private": true,
  "packageManager": "yarn@4.1.0"
}
```

这要求：
- 必须使用 Yarn v4
- lockfile 必须是 v4 格式
- 不能混用 npm 或 Yarn v1

---

## 相关文档

- [Yarn v4 迁移指南](https://yarnpkg.com/getting-started/migration)
- [Koishi 插件开发文档](https://koishi.chat/zh-CN/guide/plugin/)
- [Docker 容器管理](https://docs.docker.com/engine/reference/commandline/container/)

---

## 总结

| 步骤 | 命令 | 说明 |
|------|------|------|
| 1. 启动容器 | `docker start koishi` | 如果已停止 |
| 2. 删除 lockfile | `docker exec koishi rm -f /koishi/yarn.lock` | 删除损坏的文件 |
| 3. 安装 Git | `docker exec koishi apk add git` | 用于插件安装 |
| 4. 重新生成 | `docker exec koishi sh -c "cd /koishi && yarn install"` | 生成新 lockfile |
| 5. 重启 | `docker restart koishi` | 应用更改 |
| 6. 安装插件 | `docker exec koishi sh -c "cd /koishi && yarn add git+https://..."` | 安装 Mochi-Link |

---

**文档版本**: 1.0.0  
**最后更新**: 2026-02-17  
**适用于**: Koishi + Docker + Yarn v4  
**作者**: Kiro AI Assistant

