name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  prepare-release:
    name: Prepare Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      tag: ${{ steps.version.outputs.tag }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            TAG=${GITHUB_REF#refs/tags/}
            VERSION=${TAG#v}
          else
            # For manual trigger, get version from package.json
            VERSION=$(node -p "require('./package.json').version")
            TAG="v${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"
          echo "Release tag: ${TAG}"

  build-main-plugin:
    name: Build Main Plugin
    needs: prepare-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
      
      - name: Install dependencies
        run: npm ci
      
      - name: Build
        run: npm run build
      
      - name: Create plugin package
        run: |
          mkdir -p release/main-plugin
          cp -r lib locales package.json README.md release/main-plugin/
          cd release
          tar -czf koishi-plugin-mochi-link-${{ needs.prepare-release.outputs.version }}.tar.gz main-plugin
      
      - name: Upload main plugin artifact
        uses: actions/upload-artifact@v4
        with:
          name: main-plugin
          path: release/*.tar.gz

  build-java-connectors:
    name: Build Java Connectors
    needs: prepare-release
    runs-on: ubuntu-latest
    strategy:
      matrix:
        connector: [java, folia, nukkit]
      fail-fast: false
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: |
          if [ -f "connectors/${{ matrix.connector }}/gradlew" ]; then
            chmod +x connectors/${{ matrix.connector }}/gradlew
          fi
      
      - name: Build with Gradle
        working-directory: connectors/${{ matrix.connector }}
        run: |
          if [ -f "gradlew" ]; then
            ./gradlew clean build --no-daemon
          else
            gradle clean build --no-daemon
          fi
      
      - name: Rename artifact
        run: |
          mkdir -p release
          find connectors/${{ matrix.connector }}/build/libs -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" \
            -exec cp {} release/MochiLink-${{ matrix.connector }}-${{ needs.prepare-release.outputs.version }}.jar \;
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.connector }}-connector
          path: release/*.jar

  build-fabric:
    name: Build Fabric Connector
    needs: prepare-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: |
          if [ -f "connectors/fabric/gradlew" ]; then
            chmod +x connectors/fabric/gradlew
          fi
      
      - name: Build Fabric mod
        working-directory: connectors/fabric
        run: |
          if [ -f "gradlew" ]; then
            ./gradlew clean build --no-daemon
          else
            gradle clean build --no-daemon
          fi
        continue-on-error: true
      
      - name: Rename artifact
        run: |
          mkdir -p release
          find connectors/fabric/build/libs -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" \
            -exec cp {} release/MochiLink-fabric-${{ needs.prepare-release.outputs.version }}.jar \; || true
      
      - name: Upload artifact
        if: hashFiles('release/*.jar') != ''
        uses: actions/upload-artifact@v4
        with:
          name: fabric-connector
          path: release/*.jar

  build-forge:
    name: Build Forge Connector
    needs: prepare-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}
      
      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'
      
      - name: Grant execute permission for gradlew
        run: |
          if [ -f "connectors/forge/gradlew" ]; then
            chmod +x connectors/forge/gradlew
          fi
      
      - name: Build Forge mod
        working-directory: connectors/forge
        run: |
          if [ -f "gradlew" ]; then
            ./gradlew clean build --no-daemon
          else
            gradle clean build --no-daemon
          fi
        continue-on-error: true
      
      - name: Rename artifact
        run: |
          mkdir -p release
          find connectors/forge/build/libs -name "*.jar" -not -name "*-sources.jar" -not -name "*-javadoc.jar" \
            -exec cp {} release/MochiLink-forge-${{ needs.prepare-release.outputs.version }}.jar \; || true
      
      - name: Upload artifact
        if: hashFiles('release/*.jar') != ''
        uses: actions/upload-artifact@v4
        with:
          name: forge-connector
          path: release/*.jar

  build-llbds:
    name: Build LLBDS Connector
    needs: prepare-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'
          cache-dependency-path: connectors/llbds/package-lock.json
      
      - name: Install dependencies
        working-directory: connectors/llbds
        run: npm ci
      
      - name: Build TypeScript
        working-directory: connectors/llbds
        run: npm run build
      
      - name: Create package
        run: |
          mkdir -p release/llbds-connector
          cp -r connectors/llbds/dist/* release/llbds-connector/
          cp connectors/llbds/package.json release/llbds-connector/
          cd release
          tar -czf MochiLink-llbds-${{ needs.prepare-release.outputs.version }}.tar.gz llbds-connector
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: llbds-connector
          path: release/*.tar.gz

  build-pmmp:
    name: Package PMMP Connector
    needs: prepare-release
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}
      
      - name: Create PMMP package
        run: |
          mkdir -p release
          cd connectors/pmmp
          tar -czf ../../release/MochiLink-pmmp-${{ needs.prepare-release.outputs.version }}.tar.gz .
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: pmmp-connector
          path: release/*.tar.gz

  create-release:
    name: Create GitHub Release
    needs: 
      - prepare-release
      - build-main-plugin
      - build-java-connectors
      - build-fabric
      - build-forge
      - build-llbds
      - build-pmmp
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.prepare-release.outputs.tag }}
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Organize release files
        run: |
          mkdir -p release-package
          
          # Copy all artifacts
          find artifacts -type f \( -name "*.jar" -o -name "*.tar.gz" \) -exec cp {} release-package/ \;
          
          # Create version info
          cat > release-package/VERSION.txt << EOF
          Mochi-Link Release ${{ needs.prepare-release.outputs.version }}
          å¤§ç¦è¿ ç‰ˆæœ¬ ${{ needs.prepare-release.outputs.version }}
          
          Release Date: $(date)
          å‘å¸ƒæ—¥æœŸ: $(date)
          
          Git Tag: ${{ needs.prepare-release.outputs.tag }}
          Commit: ${{ github.sha }}
          
          ========================================
          Package Contents / åŒ…å«å†…å®¹
          ========================================
          
          Main Plugin / ä¸»æ’ä»¶:
          - koishi-plugin-mochi-link-${{ needs.prepare-release.outputs.version }}.tar.gz
          
          Java Edition Connectors / Javaç‰ˆè¿æ¥å™¨:
          - MochiLink-java-${{ needs.prepare-release.outputs.version }}.jar (Paper/Spigot)
          - MochiLink-folia-${{ needs.prepare-release.outputs.version }}.jar (Folia)
          - MochiLink-nukkit-${{ needs.prepare-release.outputs.version }}.jar (Nukkit)
          
          Modded Java Edition Connectors / æ¨¡ç»„Javaç‰ˆè¿æ¥å™¨:
          - MochiLink-fabric-${{ needs.prepare-release.outputs.version }}.jar (Fabric)
          - MochiLink-forge-${{ needs.prepare-release.outputs.version }}.jar (Forge)
          
          Bedrock Edition Connectors / åŸºå²©ç‰ˆè¿æ¥å™¨:
          - MochiLink-llbds-${{ needs.prepare-release.outputs.version }}.tar.gz (LLBDS)
          - MochiLink-pmmp-${{ needs.prepare-release.outputs.version }}.tar.gz (PMMP)
          
          ========================================
          Installation / å®‰è£…è¯´æ˜
          ========================================
          
          Main Plugin:
          1. Extract koishi-plugin-mochi-link-*.tar.gz
          2. Install in Koishi: npm install ./main-plugin
          
          Java Edition Plugins (.jar):
          1. Copy to server's plugins/ directory
          2. Restart server
          
          Fabric/Forge Mods (.jar):
          1. Copy to server's mods/ directory
          2. Restart server
          
          LLBDS Plugin (.tar.gz):
          1. Extract to LLBDS plugins/ directory
          2. Restart LLBDS
          
          PMMP Plugin (.tar.gz):
          1. Extract to PMMP plugins/ directory
          2. Restart PMMP
          
          ========================================
          Documentation / æ–‡æ¡£
          ========================================
          
          - GitHub: https://github.com/chm413/Mochi-Link
          - Wiki: https://github.com/chm413/Mochi-Link/wiki
          - Issues: https://github.com/chm413/Mochi-Link/issues
          EOF
          
          # Create README
          cat > release-package/README.md << 'EOF'
          # Mochi-Link Release Package
          # å¤§ç¦è¿å‘å¸ƒåŒ…
          
          ## What's Included / åŒ…å«å†…å®¹
          
          This release package contains:
          æ­¤å‘å¸ƒåŒ…åŒ…å«:
          
          - Main Koishi plugin / ä¸» Koishi æ’ä»¶
          - All server connectors / æ‰€æœ‰æœåŠ¡å™¨è¿æ¥å™¨
          - Installation instructions / å®‰è£…è¯´æ˜
          
          ## Quick Start / å¿«é€Ÿå¼€å§‹
          
          ### 1. Install Main Plugin / å®‰è£…ä¸»æ’ä»¶
          
          ```bash
          # Extract the main plugin
          tar -xzf koishi-plugin-mochi-link-*.tar.gz
          
          # Install in Koishi
          npm install ./main-plugin
          ```
          
          ### 2. Install Connector / å®‰è£…è¿æ¥å™¨
          
          Choose the appropriate connector for your server type and follow the installation instructions in VERSION.txt.
          
          ä¸ºæ‚¨çš„æœåŠ¡å™¨ç±»å‹é€‰æ‹©åˆé€‚çš„è¿æ¥å™¨ï¼Œå¹¶æŒ‰ç…§ VERSION.txt ä¸­çš„å®‰è£…è¯´æ˜æ“ä½œã€‚
          
          ### 3. Configure / é…ç½®
          
          Refer to the configuration templates in the `config-templates/` directory of the repository.
          
          å‚è€ƒä»“åº“ä¸­ `config-templates/` ç›®å½•ä¸‹çš„é…ç½®æ¨¡æ¿ã€‚
          
          ## Support / æ”¯æŒ
          
          - Documentation: https://github.com/chm413/Mochi-Link/wiki
          - Issues: https://github.com/chm413/Mochi-Link/issues
          - Discussions: https://github.com/chm413/Mochi-Link/discussions
          EOF
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ needs.prepare-release.outputs.tag }}^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "changelog=Initial release" >> $GITHUB_OUTPUT
          else
            CHANGELOG=$(git log ${PREV_TAG}..${{ needs.prepare-release.outputs.tag }} --pretty=format:"- %s (%h)" --no-merges)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.prepare-release.outputs.tag }}
          name: Mochi-Link ${{ needs.prepare-release.outputs.version }}
          body: |
            # Mochi-Link ${{ needs.prepare-release.outputs.version }}
            
            ## ğŸ“¦ Release Package / å‘å¸ƒåŒ…
            
            This release includes the main Koishi plugin and all server connectors.
            æ­¤ç‰ˆæœ¬åŒ…å«ä¸» Koishi æ’ä»¶å’Œæ‰€æœ‰æœåŠ¡å™¨è¿æ¥å™¨ã€‚
            
            ## ğŸ“ Changelog / æ›´æ–°æ—¥å¿—
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## ğŸ“¥ Downloads / ä¸‹è½½
            
            ### Main Plugin / ä¸»æ’ä»¶
            - `koishi-plugin-mochi-link-${{ needs.prepare-release.outputs.version }}.tar.gz`
            
            ### Java Edition Connectors / Javaç‰ˆè¿æ¥å™¨
            - `MochiLink-java-${{ needs.prepare-release.outputs.version }}.jar` - Paper/Spigot/Bukkit
            - `MochiLink-folia-${{ needs.prepare-release.outputs.version }}.jar` - Folia
            - `MochiLink-nukkit-${{ needs.prepare-release.outputs.version }}.jar` - Nukkit
            
            ### Modded Java Edition / æ¨¡ç»„Javaç‰ˆ
            - `MochiLink-fabric-${{ needs.prepare-release.outputs.version }}.jar` - Fabric
            - `MochiLink-forge-${{ needs.prepare-release.outputs.version }}.jar` - Forge
            
            ### Bedrock Edition / åŸºå²©ç‰ˆ
            - `MochiLink-llbds-${{ needs.prepare-release.outputs.version }}.tar.gz` - LLBDS
            - `MochiLink-pmmp-${{ needs.prepare-release.outputs.version }}.tar.gz` - PMMP
            
            ## ğŸ“– Documentation / æ–‡æ¡£
            
            - [Installation Guide / å®‰è£…æŒ‡å—](https://github.com/chm413/Mochi-Link/wiki)
            - [Configuration / é…ç½®è¯´æ˜](https://github.com/chm413/Mochi-Link/wiki/Configuration)
            - [API Documentation / APIæ–‡æ¡£](https://github.com/chm413/Mochi-Link/wiki/API)
            
            ## ğŸ› Bug Reports / é—®é¢˜åé¦ˆ
            
            Please report issues at: https://github.com/chm413/Mochi-Link/issues
            è¯·åœ¨æ­¤æŠ¥å‘Šé—®é¢˜: https://github.com/chm413/Mochi-Link/issues
          files: |
            release-package/*
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
