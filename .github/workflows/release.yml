name: Release Connectors

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:

jobs:
  build-connectors:
    name: Build All Connectors
    uses: ./.github/workflows/build-connectors.yml

  create-release:
    name: Create GitHub Release
    needs: build-connectors
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Determine version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            TAG=${GITHUB_REF#refs/tags/}
            VERSION=${TAG#v}
          else
            VERSION=$(node -p "require('./package.json').version")
            TAG="v${VERSION}"
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT
          echo "tag=${TAG}" >> $GITHUB_OUTPUT
          echo "Release version: ${VERSION}"
          echo "Release tag: ${TAG}"
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: release-artifacts
      
      - name: Organize release files
        run: |
          mkdir -p release-package
          
          # Copy all connector artifacts
          if [ -d "release-artifacts/java-connector" ]; then
            cp release-artifacts/java-connector/*.jar release-package/ 2>/dev/null || true
          fi
          if [ -d "release-artifacts/folia-connector" ]; then
            cp release-artifacts/folia-connector/*.jar release-package/ 2>/dev/null || true
          fi
          if [ -d "release-artifacts/nukkit-connector" ]; then
            cp release-artifacts/nukkit-connector/*.jar release-package/ 2>/dev/null || true
          fi
          if [ -d "release-artifacts/fabric-connector" ]; then
            cp release-artifacts/fabric-connector/*.jar release-package/ 2>/dev/null || true
          fi
          if [ -d "release-artifacts/forge-connector" ]; then
            cp release-artifacts/forge-connector/*.jar release-package/ 2>/dev/null || true
          fi
          
          # Package LLBDS connector
          if [ -d "release-artifacts/llbds-connector" ]; then
            cd release-artifacts/llbds-connector
            tar -czf ../../release-package/MochiLink-llbds-${{ steps.version.outputs.version }}.tar.gz .
            cd ../..
          fi
          
          # Package PMMP connector
          if [ -d "release-artifacts/pmmp-connector" ]; then
            cd release-artifacts/pmmp-connector
            tar -czf ../../release-package/MochiLink-pmmp-${{ steps.version.outputs.version }}.tar.gz .
            cd ../..
          fi
          
          # Rename JAR files with version
          cd release-package
          for jar in *.jar; do
            if [ -f "$jar" ]; then
              base=$(basename "$jar" .jar)
              # Extract connector type from filename
              if [[ "$jar" == *"java"* ]]; then
                mv "$jar" "MochiLink-java-${{ steps.version.outputs.version }}.jar"
              elif [[ "$jar" == *"folia"* ]]; then
                mv "$jar" "MochiLink-folia-${{ steps.version.outputs.version }}.jar"
              elif [[ "$jar" == *"nukkit"* ]]; then
                mv "$jar" "MochiLink-nukkit-${{ steps.version.outputs.version }}.jar"
              elif [[ "$jar" == *"fabric"* ]]; then
                mv "$jar" "MochiLink-fabric-${{ steps.version.outputs.version }}.jar"
              elif [[ "$jar" == *"forge"* ]]; then
                mv "$jar" "MochiLink-forge-${{ steps.version.outputs.version }}.jar"
              fi
            fi
          done
          cd ..
      
      - name: Create version info
        run: |
          cat > release-package/VERSION.txt << EOF
          Mochi-Link Connectors Release ${{ steps.version.outputs.version }}
          å¤§ç¦è¿è¿æ¥å™¨ç‰ˆæœ¬ ${{ steps.version.outputs.version }}
          
          Release Date: $(date)
          å‘å¸ƒæ—¥æœŸ: $(date)
          
          Git Tag: ${{ steps.version.outputs.tag }}
          Commit: ${{ github.sha }}
          
          ========================================
          Package Contents / åŒ…å«å†…å®¹
          ========================================
          
          Java Edition Connectors / Javaç‰ˆè¿æ¥å™¨:
          - MochiLink-java-${{ steps.version.outputs.version }}.jar (Paper/Spigot)
          - MochiLink-folia-${{ steps.version.outputs.version }}.jar (Folia)
          - MochiLink-nukkit-${{ steps.version.outputs.version }}.jar (Nukkit)
          
          Modded Java Edition Connectors / æ¨¡ç»„Javaç‰ˆè¿æ¥å™¨:
          - MochiLink-fabric-${{ steps.version.outputs.version }}.jar (Fabric)
          - MochiLink-forge-${{ steps.version.outputs.version }}.jar (Forge)
          
          Bedrock Edition Connectors / åŸºå²©ç‰ˆè¿æ¥å™¨:
          - MochiLink-llbds-${{ steps.version.outputs.version }}.tar.gz (LLBDS)
          - MochiLink-pmmp-${{ steps.version.outputs.version }}.tar.gz (PMMP)
          
          ========================================
          Installation / å®‰è£…è¯´æ˜
          ========================================
          
          Java Edition Plugins (.jar):
          1. Copy to server's plugins/ directory
          2. Restart server
          
          Fabric/Forge Mods (.jar):
          1. Copy to server's mods/ directory
          2. Restart server
          
          LLBDS Plugin (.tar.gz):
          1. Extract to LLBDS plugins/ directory
          2. Run npm install
          3. Restart LLBDS
          
          PMMP Plugin (.tar.gz):
          1. Extract to PMMP plugins/ directory
          2. Restart PMMP
          
          ========================================
          Documentation / æ–‡æ¡£
          ========================================
          
          - GitHub: https://github.com/chm413/Mochi-Link
          - Wiki: https://github.com/chm413/Mochi-Link/wiki
          - Issues: https://github.com/chm413/Mochi-Link/issues
          EOF
      
      - name: Create README
        run: |
          cat > release-package/README.md << 'EOF'
          # Mochi-Link Connectors Release Package
          # å¤§ç¦è¿è¿æ¥å™¨å‘å¸ƒåŒ…
          
          This package contains all built connector plugins and mods for different Minecraft server types.
          
          æ­¤åŒ…åŒ…å«ä¸ºä¸åŒç±»å‹MinecraftæœåŠ¡å™¨æ„å»ºçš„æ‰€æœ‰è¿æ¥å™¨æ’ä»¶å’Œæ¨¡ç»„ã€‚
          
          ## Installation / å®‰è£…
          
          ### Java Edition Plugins
          Copy the JAR file to your server's `plugins/` directory.
          å°†JARæ–‡ä»¶å¤åˆ¶åˆ°æœåŠ¡å™¨çš„ `plugins/` ç›®å½•ã€‚
          
          ### Fabric/Forge Mods
          Copy the JAR file to your server's `mods/` directory.
          å°†JARæ–‡ä»¶å¤åˆ¶åˆ°æœåŠ¡å™¨çš„ `mods/` ç›®å½•ã€‚
          
          ### LLBDS Plugin
          1. Extract the tar.gz file
          2. Copy to your LLBDS `plugins/` directory
          3. Run `npm install` in the plugin directory
          
          1. è§£å‹ tar.gz æ–‡ä»¶
          2. å¤åˆ¶åˆ°LLBDSçš„ `plugins/` ç›®å½•
          3. åœ¨æ’ä»¶ç›®å½•ä¸­è¿è¡Œ `npm install`
          
          ### PMMP Plugin
          1. Extract the tar.gz file
          2. Copy to your PMMP `plugins/` directory
          
          1. è§£å‹ tar.gz æ–‡ä»¶
          2. å¤åˆ¶åˆ°PMMPçš„ `plugins/` ç›®å½•
          
          ## Configuration / é…ç½®
          
          Please refer to the main project documentation for configuration instructions.
          é…ç½®è¯´æ˜è¯·å‚è€ƒä¸»é¡¹ç›®æ–‡æ¡£ã€‚
          
          ## Support / æ”¯æŒ
          
          - GitHub: https://github.com/chm413/Mochi-Link
          - Issues: https://github.com/chm413/Mochi-Link/issues
          EOF
      
      - name: Generate changelog
        id: changelog
        run: |
          # Get previous tag
          PREV_TAG=$(git describe --tags --abbrev=0 ${{ steps.version.outputs.tag }}^ 2>/dev/null || echo "")
          
          if [ -z "$PREV_TAG" ]; then
            echo "changelog=Initial release" >> $GITHUB_OUTPUT
          else
            CHANGELOG=$(git log ${PREV_TAG}..${{ steps.version.outputs.tag }} --pretty=format:"- %s (%h)" --no-merges)
            echo "changelog<<EOF" >> $GITHUB_OUTPUT
            echo "$CHANGELOG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
      
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.version.outputs.tag }}
          name: Mochi-Link Connectors ${{ steps.version.outputs.version }}
          body: |
            # Mochi-Link Connectors ${{ steps.version.outputs.version }}
            
            ## ğŸ“¦ Release Package / å‘å¸ƒåŒ…
            
            This release includes all server connectors for Minecraft.
            æ­¤ç‰ˆæœ¬åŒ…å«æ‰€æœ‰ Minecraft æœåŠ¡å™¨è¿æ¥å™¨ã€‚
            
            ## ğŸ“ Changelog / æ›´æ–°æ—¥å¿—
            
            ${{ steps.changelog.outputs.changelog }}
            
            ## ğŸ“¥ Downloads / ä¸‹è½½
            
            ### Java Edition Connectors / Javaç‰ˆè¿æ¥å™¨
            - `MochiLink-java-${{ steps.version.outputs.version }}.jar` - Paper/Spigot/Bukkit
            - `MochiLink-folia-${{ steps.version.outputs.version }}.jar` - Folia
            - `MochiLink-nukkit-${{ steps.version.outputs.version }}.jar` - Nukkit
            
            ### Modded Java Edition / æ¨¡ç»„Javaç‰ˆ
            - `MochiLink-fabric-${{ steps.version.outputs.version }}.jar` - Fabric
            - `MochiLink-forge-${{ steps.version.outputs.version }}.jar` - Forge
            
            ### Bedrock Edition / åŸºå²©ç‰ˆ
            - `MochiLink-llbds-${{ steps.version.outputs.version }}.tar.gz` - LLBDS
            - `MochiLink-pmmp-${{ steps.version.outputs.version }}.tar.gz` - PMMP
            
            ## ğŸ“– Documentation / æ–‡æ¡£
            
            - [Installation Guide / å®‰è£…æŒ‡å—](https://github.com/chm413/Mochi-Link/wiki)
            - [Configuration / é…ç½®è¯´æ˜](https://github.com/chm413/Mochi-Link/wiki/Configuration)
            - [API Documentation / APIæ–‡æ¡£](https://github.com/chm413/Mochi-Link/wiki/API)
            
            ## ğŸ› Bug Reports / é—®é¢˜åé¦ˆ
            
            Please report issues at: https://github.com/chm413/Mochi-Link/issues
            è¯·åœ¨æ­¤æŠ¥å‘Šé—®é¢˜: https://github.com/chm413/Mochi-Link/issues
          files: |
            release-package/*
          draft: false
          prerelease: false
          token: ${{ secrets.GITHUB_TOKEN }}
