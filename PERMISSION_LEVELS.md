# Mochi-Link 权限等级说明

## 权限等级体系

Mochi-Link 使用 Koishi 的权限系统，将命令分为 4 个等级：

| 等级 | 名称 | 说明 | 适用人群 |
|------|------|------|----------|
| 1 | 普通用户 | 只能查看信息，不能进行任何操作 | 所有用户 |
| 2 | 受信任用户 | 可以进行基本操作，如白名单管理 | 服主信任的玩家 |
| 3 | 管理员 | 可以进行管理操作，如添加服务器、踢人 | 服务器管理员 |
| 4 | 超级管理员 | 可以进行危险操作，如删除服务器、执行命令 | 服主或核心管理员 |

## 命令权限分级

### 等级 1 - 普通用户（查看信息）

所有用户都可以使用这些命令查看信息：

- `mochi` - 显示欢迎信息
- `mochi.server.list` - 列出所有服务器
- `mochi.server.info <id>` - 查看服务器详细信息
- `mochi.player.list [serverId]` - 查看在线玩家列表
- `mochi.player.info <serverId> <player>` - 查看玩家信息
- `mochi.whitelist.list [serverId]` - 查看白名单
- `mochi.bind.list` - 查看频道绑定

### 等级 2 - 受信任用户（基本操作）

需要等级 2 或更高权限：

- `mochi.server` - 服务器管理菜单
- `mochi.player` - 玩家管理菜单
- `mochi.whitelist` - 白名单管理菜单
- `mochi.whitelist.add [serverId] <player>` - 添加白名单
- `mochi.whitelist.remove <serverId> <player>` - 移除白名单
- `mochi.bind` - 频道绑定管理菜单

### 等级 3 - 管理员（管理操作）

需要等级 3 或更高权限：

- `mochi.server.add <id> <name>` - 添加服务器
- `mochi.player.kick <serverId> <player> [reason]` - 踢出玩家
- `mochi.bind.add <serverId>` - 添加频道绑定
- `mochi.bind.remove <bindingId>` - 移除频道绑定
- `mochi.audit` - 查看审计日志

### 等级 4 - 超级管理员（危险操作）

需要等级 4 权限：

- `mochi.server.remove <id>` - 删除服务器（危险）
- `mochi.exec <serverId> <command...>` - 执行服务器命令（危险）

## 权限设置方法

### 在 Koishi 中设置用户权限

1. 使用 Koishi 的用户管理功能
2. 找到目标用户
3. 设置其 `authority` 字段为对应等级（1-4）

### 命令行设置（需要数据库访问）

```sql
-- 设置用户为管理员（等级 3）
UPDATE user SET authority = 3 WHERE id = 'user_id';

-- 设置用户为超级管理员（等级 4）
UPDATE user SET authority = 4 WHERE id = 'user_id';
```

### 通过 Koishi 插件设置

使用 Koishi 的 `admin` 插件或其他权限管理插件来设置用户权限。

## 权限检查机制

- 所有需要权限的命令都会在执行前检查用户的 `authority` 字段
- 如果权限不足，会返回明确的错误提示，告知需要的权限等级
- 权限检查在命令的 `before` 钩子中进行，确保安全性

## 安全建议

1. **谨慎授予等级 4 权限**：超级管理员可以执行任意服务器命令，可能造成严重后果
2. **定期审查权限**：使用 `mochi.audit` 命令查看操作日志
3. **最小权限原则**：只授予用户完成任务所需的最低权限
4. **分级管理**：
   - 普通玩家：等级 1（只能查看）
   - 白名单管理员：等级 2（可以管理白名单）
   - 服务器管理员：等级 3（可以管理服务器和玩家）
   - 服主/核心管理：等级 4（完全控制）

## 权限不足提示

当用户尝试使用超出其权限的命令时，会收到以下提示：

- 等级 2 需求：`权限不足：需要受信任用户权限（等级 2）`
- 等级 3 需求：`权限不足：需要管理员权限（等级 3）`
- 等级 4 需求：`权限不足：需要超级管理员权限（等级 4）`

## 示例场景

### 场景 1：普通玩家
小明是服务器的普通玩家（等级 1）：
- ✅ 可以查看服务器列表和在线玩家
- ❌ 不能添加白名单
- ❌ 不能踢人
- ❌ 不能执行命令

### 场景 2：白名单管理员
小红是白名单管理员（等级 2）：
- ✅ 可以查看所有信息
- ✅ 可以添加/移除白名单
- ❌ 不能添加服务器
- ❌ 不能踢人
- ❌ 不能执行命令

### 场景 3：服务器管理员
小刚是服务器管理员（等级 3）：
- ✅ 可以查看所有信息
- ✅ 可以管理白名单
- ✅ 可以添加服务器
- ✅ 可以踢出玩家
- ✅ 可以查看审计日志
- ❌ 不能删除服务器
- ❌ 不能执行任意命令

### 场景 4：服主
服主（等级 4）：
- ✅ 可以使用所有命令
- ✅ 可以删除服务器
- ✅ 可以执行任意服务器命令
- ⚠️ 需要谨慎操作

## 更新日志

- **2026-02-22**: 初始版本，实现四级权限体系
