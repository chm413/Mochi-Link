# Mochi-Link (大福连) - 需求文档

## 简介

本文档规定了 Mochi-Link（大福连）- Minecraft 统一管理与监控系统的需求。该系统如同大福（麻薯）一样具有极强的黏性和包容性，把各种核心（LLBDS、Paper、Folia 等）软糯地包裹在一起，创建一个"全核心统一"的 MC 服务器管理层。不管是 LLBD/基岩版、Paper/Folia 还是其他核心，都通过同一套 WebSocket 接口对外暴露能力。系统采用 Koishi 插件作为管理端，通过标准化的 U-WBP v2 协议与各种服务器端 Connector/Bridge 通信。

## 术语表

- **Connector_Bridge**: 游戏端插件，针对不同核心实现（LLBDS、Paper/Folia 等），负责将核心原生接口转换为标准 WS API
- **Koishi_插件**: 管理端组件，使用 Koishi 的数据库和权限系统进行多服务器、多群组、多服主管理
- **U_WBP_v2**: 统一 WebSocket 协议版本 2，标准化的 JSON 消息格式
- **serverId**: 服务器唯一标识符
- **正向连接**: Koishi_插件作为 WebSocket 客户端连接到 Connector_Bridge
- **反向连接**: Connector_Bridge 作为 WebSocket 客户端连接到 Koishi_插件
- **能力声明**: Connector 向管理端声明支持的功能列表（capabilities）
- **绑定路由**: 群聊与服务器的多对多绑定关系
- **API_令牌**: 服务器认证 token，支持 IP 白名单和可选加密
- **审计记录**: 所有管理动作的日志记录，包含操作者、时间、目标、结果

## 需求

### 需求 1：跨核心统一接口

**用户故事：** 作为服务器管理员，我希望通过统一的接口管理不同类型的 Minecraft 服务器，无论是基岩版还是 Java 版，都能使用相同的管理方式。

#### 验收标准

1. 当连接基岩版服务器（LLBDS/Nukkit/PMMP/BDS）时，系统应通过对应的 Connector_Bridge 提供统一的 WebSocket API
2. 当连接 Java 版服务器（Paper/Folia/Fabric/Forge/Mohist/Geyser）时，系统应通过对应的 Connector_Bridge 提供统一的 WebSocket API
3. 当不同核心的服务器同时连接时，系统应通过相同的 U_WBP_v2 协议进行通信
4. 当核心版本更新时，系统应通过 Connector_Bridge 的抽象层保持兼容性
5. 系统应将所有核心特定的实现细节封装在 Connector_Bridge 内部

### 需求 2：双向连接架构

**用户故事：** 作为系统架构师，我希望支持正向和反向两种 WebSocket 连接模式，以适应不同的网络架构和负载分担需求。

#### 验收标准

1. 当使用正向连接时，Koishi_插件应作为 WebSocket 客户端连接到 Connector_Bridge 的端口 A
2. 当使用反向连接时，Connector_Bridge 应作为 WebSocket 客户端连接到 Koishi_插件的端口 B
3. 当建立连接时，系统应支持连接模式的动态切换
4. 当连接建立后，系统应使用相同的 U_WBP_v2 协议，无论连接方向如何
5. 系统应实现心跳重连机制和能力声明交换

### 需求 3：多服务器与多群管理

**用户故事：** 作为服务器管理员，我希望在一个 Koishi 实例中管理多台 MC 服务器，并支持群聊与服务器的灵活绑定。

#### 验收标准

1. 当注册服务器时，系统应在 Koishi 数据库中存储服务器配置（serverId、token、备注、标签等）
2. 当配置群服绑定时，系统应支持一个群绑定多个服务器，一个服务器绑定多个群的多对多关系
3. 当收到群聊消息时，系统应根据绑定路由将消息转发到对应的服务器
4. 当管理服务器时，系统应支持按服主账号进行权限隔离
5. 系统应支持服务器的 CRUD 操作和状态管理

### 需求 4：统一玩家信息管理

**用户故事：** 作为服务器管理员，我希望获取统一格式的玩家信息，无论玩家在哪种类型的服务器上，并能正确处理非正版玩家可能存在的信息差异。

#### 验收标准

1. 当查询玩家列表时，系统应返回统一格式的玩家信息（UUID/XUID、名称、显示名、世界、坐标、延迟等）
2. 当查询玩家详细信息时，系统应返回扩展信息（首次加入时间、在线时长、IP、设备类型、账号状态、权限等）
3. 当处理非正版玩家时，系统应识别并标记可能存在的信息差异（如相同名称不同 UUID 的情况）
4. 当跨服务器查询玩家时，系统应基于多个标识符（名称、UUID、IP 等）进行匹配，并标注匹配的可信度
5. 当玩家信息更新时，系统应通过事件推送机制实时通知管理端
6. 当处理不同核心的玩家数据时，系统应将其标准化为统一的数据结构，并保留原始标识符信息
7. 系统应支持跨服务器的玩家信息聚合和搜索，同时处理非正版玩家的身份识别问题

### 需求 5：统一黑白名单与封禁系统

**用户故事：** 作为服务器管理员，我希望通过统一的接口管理各服务器独立的黑白名单和封禁系统，并支持离线操作缓存。

#### 验收标准

1. 当管理白名单时，系统应为每个服务器维护独立的白名单，不同服务器间的白名单不互通
2. 当操作白名单时，系统应以 Minecraft 服务器为主要数据源，Koishi 端保存副本用于快速查询和检测
3. 当服务器在线时，系统应实现双端白名单同步，确保 Koishi 端和服务器端数据一致
4. 当服务器离线时，系统应将白名单操作添加到缓存区，等待服务器上线后执行
5. 当缓存区存在相同玩家的可抵消操作时，系统应直接修改前一操作而不是添加新操作
6. 当执行封禁操作时，系统应支持按玩家、IP、设备等不同维度进行封禁
7. 当设置封禁时，系统应支持指定原因和到期时间
8. 当查询封禁记录时，系统应返回完整的封禁信息列表
9. 系统应将不同核心的黑白名单和封禁机制抽象为统一的 WebSocket API

### 需求 6：控制台命令与快捷操作

**用户故事：** 作为服务器管理员，我希望远程执行控制台命令和常用的快捷操作。

#### 验收标准

1. 当执行控制台命令时，系统应将任意字符串指令发送到核心控制台并返回执行结果
2. 当执行快捷操作时，系统应提供踢人、广播消息、私聊玩家、设置时间天气等常用功能
3. 当执行服务器级操作时，系统应支持保存世界、重载配置、优雅关服重启等功能
4. 当命令执行完成时，系统应返回执行结果，支持分页或截断长输出
5. 系统应记录所有命令执行的审计日志

### 需求 7：实时事件推送系统

**用户故事：** 作为服务器管理员，我希望实时接收服务器事件，以便及时了解服务器状态和玩家活动。

#### 验收标准

1. 当玩家事件发生时，系统应推送 player.join、player.leave、player.chat、player.death、player.advancement 等事件
2. 当服务器状态变化时，系统应推送 server.status、server.logLine 等事件
3. 当出现告警情况时，系统应推送 alert.tpsLow、alert.memoryHigh、alert.playerFlood 等告警事件
4. 当管理端订阅事件时，系统应支持按服务器、事件类型进行过滤
5. 系统应在所有事件中包含 serverId、time、version 等基础字段

### 需求 8：性能监控与指标收集

**用户故事：** 作为服务器运维人员，我希望监控服务器的性能指标，通过服务器主动上报机制减少管理端的请求压力。

#### 验收标准

1. 当服务器运行时，Connector_Bridge 应定时主动上报服务器状态（在线状态、开服时长、当前 TPS、玩家数等）到 Koishi_插件
2. 当性能指标变化时，Connector_Bridge 应定时上报详细指标（CPU 利用率、内存占用、延迟等）避免 Koishi 发出大量请求
3. 当查询历史数据时，系统应基于上报的数据提供 TPS 曲线、玩家数变化等历史数据
4. 当性能指标异常时，系统应通过告警事件立即通知管理端，不等待定时上报
5. 当管理端需要实时数据时，系统应支持主动查询作为定时上报的补充
6. 系统应支持配置上报频率，平衡数据实时性和系统性能
7. 当服务器离线时，系统应停止期待状态上报并标记服务器为离线状态

### 需求 9：安全认证与权限控制

**用户故事：** 作为安全管理员，我希望系统具有完善的认证和权限控制机制，支持不同服务器的权限分离和角色管理。

#### 验收标准

1. 当 Connector_Bridge 连接时，系统应通过 serverId 和 token 进行身份验证
2. 当建立连接时，系统应支持可选的 IP 白名单验证
3. 当传输敏感数据时，系统应支持可选的 AES/RSA 通信加密
4. 当执行管理操作时，系统应基于 Koishi 权限系统进行授权检查，使用 "serverId.操作" 格式的权限命名
5. 当分配权限时，系统应支持基于角色的权限管理（如腐竹、管理员等身份），每个角色对应特定服务器的操作权限
6. 当用户管理多个服务器时，系统应确保用户只能操作有权限的服务器
7. 当权限检查时，系统应同时验证用户对特定服务器的访问权限和具体操作权限
8. 系统应支持权限的继承和委派，允许服主为其服务器指定管理员
9. 系统应记录所有权限相关的操作和变更

### 需求 10：审计日志与操作记录

**用户故事：** 作为合规管理员，我希望系统记录所有管理操作的详细日志，以便进行审计和问题追踪。

#### 验收标准

1. 当执行管理操作时，系统应记录操作者（QQ/账号）、目标服务器、操作内容、执行时间
2. 当操作完成时，系统应记录操作结果（成功/失败/错误信息）
3. 当查询审计日志时，系统应提供按时间、操作者、服务器等维度的过滤功能
4. 当需要合规报告时，系统应提供审计日志的导出功能
5. 系统应确保审计日志的完整性和不可篡改性

### 需求 11：WebSocket 协议实现

**用户故事：** 作为系统集成者，我希望有标准化的 WebSocket 协议，确保不同组件间的可靠通信。

#### 验收标准

1. 当发送消息时，系统应使用统一的 JSON 格式，包含 type、id、op、data 等标准字段
2. 当处理请求响应时，系统应通过 id 字段进行请求响应匹配
3. 当推送事件时，系统应使用标准的事件消息格式
4. 当连接建立时，系统应执行握手流程，包括认证和能力声明交换
5. 系统应实现心跳机制（system.ping/pong）和优雅断开连接（system.disconnect）

### 需求 12：错误处理与连接恢复

**用户故事：** 作为系统运维人员，我希望系统能够优雅地处理各种错误情况并自动恢复连接。

#### 验收标准

1. 当 WebSocket 连接断开时，系统应实现指数退避的自动重连机制
2. 当认证失败时，系统应返回明确的错误码和错误信息
3. 当协议错误发生时，系统应记录错误日志并尝试恢复通信
4. 当单个服务器不可用时，系统应继续为其他服务器提供服务
5. 系统应提供健康检查接口，便于监控系统状态

### 需求 13：扩展模块集成

**用户故事：** 作为插件开发者，我希望系统能够集成常用的 Minecraft 插件，提供更丰富的功能。

#### 验收标准

1. 当 PlaceholderAPI（PAPI）可用时，系统应集成以访问服务器占位符和变量
2. 当 Plan 分析插件存在时，系统应集成以获取服务器统计和玩家数据
3. 当 LuckPerms 安装时，系统应集成以提供高级权限管理功能
4. 当 Vault 可用时，系统应集成以支持经济和权限系统
5. 系统应优雅处理扩展模块缺失的情况，提供基础功能作为回退

### 需求 14：HTTP API 接口

**用户故事：** 作为系统集成者，我希望有完整的 HTTP API 接口，以便将此系统集成到更大的管理系统中。

#### 验收标准

1. 系统应提供完整的 RESTful API 以访问所有管理功能
2. 当外部系统调用 API 时，系统应根据 API 令牌权限验证和执行操作
3. 当执行管理操作时，API 应返回标准化的 JSON 响应和适当的 HTTP 状态码
4. 系统应提供 OpenAPI/Swagger 规范文档以便于集成
5. API 应支持批量操作和异步任务处理以提高效率

### 需求 15：数据库模型设计

**用户故事：** 作为数据库管理员，我希望有完整的数据库结构来支持多服务器管理、权限控制、认证和审计功能。

#### 验收标准

1. 当系统初始化时，系统应创建 minecraft_servers 表存储服务器配置（serverId、名称、核心类型、连接信息、接入模式、状态、服主信息、标签等）
2. 当管理访问控制时，系统应使用 server_acl 表存储用户与服务器的权限关系（用户ID、serverId、角色、权限列表、授权时间等）
3. 当处理 API 认证时，系统应使用 api_tokens 表管理服务器认证令牌（serverId、token、创建时间、过期时间、IP白名单、加密配置等）
4. 当记录操作审计时，系统应使用 audit_logs 表存储所有管理操作（操作者、serverId、操作类型、操作内容、时间戳、结果、IP地址等）
5. 当存储离线操作时，系统应创建 pending_operations 表缓存服务器离线时的操作（serverId、操作类型、目标、参数、创建时间、状态等）
6. 当管理群服绑定时，系统应创建 server_bindings 表存储群聊与服务器的绑定关系（群ID、serverId、绑定类型、创建时间等）
7. 当缓存玩家信息时，系统应创建 player_cache 表存储跨服务器的玩家信息（UUID、名称、最后在线服务器、最后在线时间、标识符匹配信息等）
8. 系统应在相关表之间建立适当的外键约束和索引以确保数据完整性和查询性能
9. 系统应支持数据库迁移和版本管理，确保平滑升级

### 需求 16：多种服务器接入模式

**用户故事：** 作为系统集成者，我希望支持多种服务器接入模式，以适应不同的部署环境和服务器配置。

#### 验收标准

1. 当服务器支持插件时，系统应提供直接插件连接模式，通过 Connector_Bridge 插件建立 WebSocket 连接
2. 当服务器启用 RCON 时，系统应支持 RCON 连接模式，通过 RCON 协议执行命令和获取信息
3. 当需要接管服务器进程时，系统应支持终端注入连接模式，通过接管相关进程的输入输出流进行控制
4. 当选择接入模式时，系统应根据服务器类型和可用接口自动选择最优的连接方式
5. 当多种模式可用时，系统应支持模式的动态切换和故障转移
6. 当使用不同接入模式时，系统应将底层差异抽象为统一的 U_WBP_v2 协议接口
7. 系统应为每种接入模式提供相应的配置选项和连接参数
8. 当接入模式不可用时，系统应提供明确的错误信息和替代方案建议
9. 系统应记录每个服务器使用的接入模式和连接状态