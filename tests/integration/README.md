# 集成测试套件

此目录包含 Mochi-Link（大福连）Minecraft 统一管理与监控系统的全面集成测试。这些测试验证所有组件和场景的完整系统功能。

## 测试结构

### 测试类别

1. **端到端集成测试** (`end-to-end.test.ts`)
   - 完整的系统启动和关闭
   - 服务器注册和管理工作流
   - 玩家管理工作流
   - 命令执行流程
   - 事件系统流程
   - HTTP API 集成
   - 健康监控集成
   - 错误处理和恢复
   - 负载下的性能
   - 数据一致性

2. **多服务器场景测试** (`multi-server-scenarios.test.ts`)
   - 多服务器注册和管理
   - 跨服务器玩家管理
   - 多服务器命令执行
   - 多服务器事件聚合
   - 多服务器性能监控
   - 多服务器负载均衡
   - 多服务器数据同步
   - 多服务器容错

3. **性能和负载测试** (`performance-load.test.ts`)
   - 系统启动性能
   - 负载下的数据库性能
   - WebSocket 连接性能
   - HTTP API 性能
   - 内存性能和泄漏检测
   - 性能优化验证
   - 压力测试
   - 性能监控准确性

4. **容错测试** (`fault-tolerance.test.ts`)
   - 数据库故障恢复
   - WebSocket 连接故障
   - HTTP 服务器故障
   - 服务故障隔离
   - 错误处理和恢复机制
   - 健康监控和告警
   - 故障期间的数据一致性
   - 优雅降级
   - 灾难恢复

5. **综合测试套件** (`comprehensive-suite.test.ts`)
   - 系统集成验证
   - 多服务器场景验证
   - 性能验证
   - 容错验证
   - 整体系统验证
   - 生产就绪性评估

## 运行集成测试

### 前提条件

1. **Node.js 和 npm**: 确保您已安装 Node.js 16+ 和 npm
2. **依赖项**: 安装所有项目依赖项
   ```bash
   npm install
   ```

### 运行测试

#### 选项 1: 使用测试运行器脚本（推荐）

```bash
# 运行所有集成测试并生成全面报告
npm run test:integration

# 或直接使用 node
node scripts/run-integration-tests.js
```

#### 选项 2: 直接使用 Jest

```bash
# 运行所有集成测试
npx jest --config jest.integration.config.js

# 运行特定测试套件
npx jest tests/integration/end-to-end.test.ts --config jest.integration.config.js

# 运行并显示详细输出
npx jest --config jest.integration.config.js --verbose

# 运行并生成覆盖率报告（不推荐用于集成测试）
npx jest --config jest.integration.config.js --coverage
```

#### 选项 3: 单独的测试套件

```bash
# 端到端测试
npx jest tests/integration/end-to-end.test.ts

# 多服务器场景
npx jest tests/integration/multi-server-scenarios.test.ts

# 性能和负载测试
npx jest tests/integration/performance-load.test.ts

# 容错测试
npx jest tests/integration/fault-tolerance.test.ts

# 综合套件
npx jest tests/integration/comprehensive-suite.test.ts
```

### 测试配置

集成测试使用专门的 Jest 配置 (`jest.integration.config.js`)，包含：

- **扩展超时**: 每个测试 5 分钟以适应复杂场景
- **顺序执行**: 测试逐个运行以避免端口冲突
- **详细输出**: 详细的测试执行信息
- **错误检测**: 自动检测开放句柄和内存泄漏
- **强制退出**: 确保测试不会无限期挂起

## 测试环境

### 模拟上下文

所有集成测试都使用全面的模拟 Koishi 上下文，模拟：

- **数据库操作**: 带可配置响应的 CRUD 操作
- **日志记录**: 不同级别的结构化日志记录
- **配置**: 测试特定的配置值
- **事件系统**: 事件发射和处理

### 端口配置

每个测试套件使用不同的端口范围以避免冲突：

- 端到端测试: 18080-18081
- 多服务器测试: 19080-19081
- 性能测试: 20080-20081
- 容错测试: 21080-21081
- 综合套件: 22080-22081

### 测试数据

测试使用代表现实场景的模拟数据：

- **服务器配置**: 具有不同连接模式的 Java 和基岩版服务器
- **玩家数据**: 包括跨平台场景的真实玩家信息
- **性能指标**: 用于监控测试的模拟性能数据
- **错误条件**: 用于容错测试的各种故障场景

## 测试验证

### 成功标准

测试验证以下方面：

1. **功能正确性**: 所有功能按规范工作
2. **性能要求**: 系统满足性能基准
3. **容错性**: 系统优雅地处理故障
4. **数据一致性**: 数据在操作过程中保持一致
5. **资源管理**: 适当的清理和资源管理
6. **错误处理**: 适当的错误响应和恢复

### 性能基准

- **启动时间**: 系统应在 10-15 秒内启动
- **响应时间**: API 响应应在 1-2 秒内
- **吞吐量**: 系统应处理每秒 10+ 次操作
- **内存使用**: 内存增长应受控且可预测
- **并发操作**: 系统应处理 50-100 个并发操作

### 容错要求

- **服务隔离**: 一个服务的故障不应导致系统崩溃
- **优雅降级**: 系统应在故障期间提供减少的功能
- **恢复机制**: 系统应从瞬态故障中恢复
- **数据保护**: 关键数据应在故障期间得到保护
- **告警生成**: 系统应为故障生成适当的告警

## 故障排除

### 常见问题

1. **端口冲突**
   - 确保没有其他服务使用测试端口
   - 测试使用不同的端口范围以最小化冲突
   - 终止任何挂起的进程: `pkill -f node`

2. **超时错误**
   - 集成测试有扩展的超时时间（5 分钟）
   - 检查系统资源和性能
   - 如果系统较慢，考虑单独运行测试

3. **内存问题**
   - 测试包括内存泄漏检测
   - 确保有足够的系统内存（推荐 4GB+）
   - 在适当的地方使用强制垃圾回收

4. **数据库模拟问题**
   - 检查测试设置中的模拟数据库响应
   - 验证模拟数据匹配预期格式
   - 审查数据库操作调用模式

### 调试模式

启用调试模式以获得详细的测试执行信息：

```bash
# 设置调试环境变量
DEBUG=mochi-link:* npm run test:integration

# 或直接使用 Jest
DEBUG=mochi-link:* npx jest --config jest.integration.config.js --verbose
```

### 测试报告

集成测试生成详细报告：

- **控制台输出**: 实时测试执行状态
- **JSON 报告**: 详细结果保存到 `integration-test-report.json`
- **JUnit XML**: JUnit 格式的测试结果，用于 CI/CD 集成

## 持续集成

### CI/CD 集成

集成测试专为 CI/CD 环境设计：

```yaml
# GitHub Actions 工作流示例
- name: 运行集成测试
  run: |
    npm install
    npm run test:integration
  timeout-minutes: 30
```

### Docker 支持

测试可以在 Docker 容器中运行：

```dockerfile
# 测试用 Dockerfile 示例
FROM node:16-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run test:integration
```

## 贡献

### 添加新测试

1. **遵循命名约定**: 使用描述性的测试名称
2. **使用适当的设置/清理**: 确保适当的清理
3. **模拟外部依赖**: 使用全面的模拟
4. **包含错误情况**: 测试成功和失败场景
5. **记录测试目的**: 添加清晰的描述

### 测试指南

1. **独立性**: 测试不应相互依赖
2. **确定性**: 测试应产生一致的结果
3. **全面性**: 涵盖正常路径和边缘情况
4. **性能意识**: 考虑测试执行时间
5. **资源清理**: 始终清理资源

### 代码审查检查清单

- [ ] 测试是独立的，可以按任何顺序运行
- [ ] 适当的设置和清理程序
- [ ] 全面的错误处理
- [ ] 真实的模拟数据和场景
- [ ] 性能考虑
- [ ] 清晰的测试描述和注释
- [ ] 适当的断言和验证

## 架构验证

集成测试验证以下架构方面：

### 组件集成
- 所有服务正确集成
- 事件系统跨组件工作
- 数据库操作一致
- WebSocket 和 HTTP 服务器正确协调

### 跨核心兼容性
- Java 和基岩版服务器支持
- 不同连接模式（插件、RCON、终端）
- 不同服务器类型的统一 API
- 跨平台玩家身份解析

### 可扩展性
- 多服务器管理
- 并发操作处理
- 负载分发和均衡
- 资源利用优化

### 可靠性
- 容错和恢复
- 数据一致性保证
- 错误处理和报告
- 系统监控和告警

这些集成测试确保 Mochi-Link 系统满足其设计目标，即提供统一、可扩展和可靠的 Minecraft 服务器管理平台。